<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amharic Search Tool</title>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <div class="container">
        <div class="title-container">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="Andemta Logo" />
            <h1>አማርኛ ቃላት ማሰሻ</h1>
        </div>

        <!-- Step 1: Upload File -->
        <div id="step-1" class="step">
            <h2>Upload Your File</h2>
            <input type="file" id="file" required>
            <button id="upload-btn" class="btn">Upload</button>
            <p class="error-message hidden" id="file-error">Please select a file to upload.</p>
        </div>

        <!-- Step 2: Choose Search Mode -->
        <div id="step-2" class="step hidden">
            <h2>Choose Search Mode</h2>
            <p><strong>Uploaded File:</strong> <span id="uploaded-file-name"></span></p>
            <select id="mode" required>
                <option value="" disabled selected>Select Mode</option>
                <option value="1">ቤት (House)</option>
                <option value="2">ቅርጽ (Form)</option>
                <option value="3">ቁጥሮች (Numbers)</option>
            </select>
            <button id="mode-btn" class="btn">Next</button>
            <p class="error-message hidden" id="mode-error">Please select a search mode.</p>
        </div>

        <!-- Step 3: Tailored Search Inputs -->
        <div id="house-options" class="step hidden">
            <h2>Enter Search Details</h2>
            <p><strong>Uploaded File:</strong> <span id="uploaded-file-name-step3"></span></p>
            <p><strong>Selected Mode:</strong> <span id="selected-mode"></span></p>
        
            <div id="general-input">
                <div class="form-group">
                    <label for="pattern">Enter the text you are searching for:</label>
                    <input type="text" id="pattern" placeholder="ምሳሌ፡ ጀመረ, ጠረገ..." required>
                    <p class="error-message hidden" id="pattern-error">Please enter a valid pattern.</p>
                </div>
                <div class="form-group">
                    <label for="missing-chars">If any character is optional to exclude from the sequence (e.g., ከ, ተ, ማ):</label>
                    <input type="text" id="missing-chars" placeholder="ምሳሌ፡ አ ከ ለ">
                </div>
                <div class="form-group">
                    <label for="repeated-chars">If any character may repeat in the sequence:</label>
                    <input type="text" id="repeated-chars" placeholder="ምሳሌ፡ ተ ነ">
                </div>
                <div class="form-group">
                    <label for="as-is-chars">If any character must remain unchanged (no vowel change):</label>
                    <input type="text" id="as-is-chars" placeholder="ምሳሌ፡ አ ለ">
                </div>
                <div class="form-group inline-options">
                    <label for="include-prefix">Include Prefix</label>
                    <input type="checkbox" id="include-prefix">
                    <label for="include-suffix">Include Suffix</label>
                    <input type="checkbox" id="include-suffix">
                </div>
            </div>

            <div id="form-options" class="step hidden">
                <h2>Enter Search Details</h2>
                <p><strong>Uploaded File:</strong> <span id="uploaded-file-name-step3"></span></p>
                <p><strong>Selected Mode:</strong> <span id="selected-mode"></span></p>
        
                <div id="general-input">
                    <div class="form-group">
                        <label for="pattern">Enter the pattern you are searching for:</label>
                        <input type="text" id="pattern" placeholder="ምሳሌ፡ 143, 626..." required>
                        <p class="error-message hidden" id="pattern-error">Please enter a valid pattern.</p>
                    </div>
                    <div class="form-group inline-options">
                        <label for="include-prefix">Include Prefix</label>
                        <input type="checkbox" id="include-prefix">
                        <label for="include-suffix">Include Suffix</label>
                        <input type="checkbox" id="include-suffix">
                    </div>
                </div>
            </div>
            
        
            <button id="pattern-btn" class="btn">Search</button>
        </div>

        <!-- Results Section -->
        <div id="results-container" class="hidden">
            <h2>Results</h2>
            <div id="results"></div>
        </div>

        <div id="loading" class="hidden">
            <p>Processing your request...</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
    const uploadBtn = document.getElementById('upload-btn');
    const modeBtn = document.getElementById('mode-btn');
    const patternBtn = document.getElementById('pattern-btn');

    const step1 = document.getElementById('step-1');
    const step2 = document.getElementById('step-2');
    const houseOptions = document.getElementById('house-options');
    const formOptions = document.getElementById('form-options');
    const numbersOptions = document.getElementById('numbers-options'); // If this exists
    const resultsContainer = document.getElementById('results-container');
    const resultsDiv = document.getElementById('results');
    const loadingDiv = document.getElementById('loading');

    const uploadedFileName = document.getElementById('uploaded-file-name');
    const uploadedFileNameStep3 = document.getElementById('uploaded-file-name-step3');
    const selectedModeSpan = document.getElementById('selected-mode');

    const fileError = document.getElementById('file-error');
    const modeError = document.getElementById('mode-error');
    const patternError = document.getElementById('pattern-error');

    let uploadedFile = null;

    // Step 1: Handle file upload
    uploadBtn.addEventListener('click', () => {
        const fileInput = document.getElementById('file');
        const file = fileInput?.files[0];

        if (!file) {
            fileError.classList.remove('hidden');
            return;
        }

        fileError.classList.add('hidden');
        uploadedFile = file;
        uploadedFileName.textContent = file.name;
        uploadedFileNameStep3.textContent = file.name;

        step1.classList.add('hidden');
        step2.classList.remove('hidden');
    });

    // Step 2: Handle mode selection
    modeBtn.addEventListener('click', () => {
        const mode = document.getElementById('mode').value;

        console.log(mode);

        if (!mode) {
            modeError.classList.remove('hidden');
            return;
        }

        modeError.classList.add('hidden');
        selectedModeSpan.textContent = document.querySelector(`#mode option[value="${mode}"]`).textContent;

        // Show/hide specific options based on mode
        if (mode === '1') {
            houseOptions?.classList.remove('hidden');
            formOptions?.classList.add('hidden');
            numbersOptions?.classList.add('hidden');
        } else if (mode === '2') {
            houseOptions?.classList.add('hidden');
            formOptions?.classList.remove('hidden');
            numbersOptions?.classList.add('hidden');
        } else if (mode === '3') {
            houseOptions?.classList.add('hidden');
            formOptions?.classList.add('hidden');
            numbersOptions?.classList.remove('hidden');
        }

        step2.classList.add('hidden');
    });

    // Step 3: Handle search logic (pattern button click)
    patternBtn.addEventListener('click', () => {
        const pattern = document.getElementById('pattern')?.value;
        const missingChars = document.getElementById('missing-chars')?.value || '';
        const repeatedChars = document.getElementById('repeated-chars')?.value || '';
        const asIsChars = document.getElementById('as-is-chars')?.value || '';
        const includePrefix = document.getElementById('include-prefix')?.checked || false;
        const includeSuffix = document.getElementById('include-suffix')?.checked || false;

        if (!pattern) {
            patternError.classList.remove('hidden');
            return;
        }

        patternError.classList.add('hidden');

        const formData = new FormData();
        formData.append('file', uploadedFile);
        formData.append('pattern', pattern);
        formData.append('include_prefix', includePrefix);
        formData.append('include_suffix', includeSuffix);
        formData.append('missing_chars', missingChars);
        formData.append('repeated_chars', repeatedChars);
        formData.append('as_is_chars', asIsChars);

        houseOptions.classList.add('hidden');
        formOptions.classList.add('hidden');
        numbersOptions?.classList.add('hidden');
        loadingDiv.classList.remove('hidden');

        fetch('/process', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                loadingDiv.classList.add('hidden');

                if (data.error) {
                    resultsDiv.innerHTML = `<p class="error">Error: ${data.error}</p>`;
                } else {
                    resultsDiv.innerHTML = `
                        <p><strong>Matches:</strong> ${data.matches.join(', ')}</p>
                        ${data.matching_sentences?.length > 0 ? `<p><strong>Matching Sentences:</strong> ${data.matching_sentences.join('<br>')}</p>` : ''}
                        <p><strong>Runtime:</strong> ${data.runtime} seconds</p>
                    `;
                }

                resultsContainer.classList.remove('hidden');
            })
            .catch(error => {
                loadingDiv.classList.add('hidden');
                resultsDiv.innerHTML = '<p class="error">Failed to process search. Please try again.</p>';
                resultsContainer.classList.remove('hidden');
            });
    });
});
    </script>       
</body>
</html>
